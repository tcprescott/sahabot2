# SpeedGaming API Integration - Implementation Summary

## Overview

This implementation adds complete SpeedGaming.org integration to SahaBot2, enabling automated tournament workflows by importing SpeedGaming episodes as matches in the application.

## What Was Implemented

### Core Features

✅ **SpeedGaming API Client**
- `SpeedGamingService` with async HTTP client
- `get_episode(episode_id)` - Fetch single episode
- `get_upcoming_episodes_by_event(event_slug)` - Get schedule
- Data classes for Episode, Player, Crew, Match, Event, Channel
- Error handling and logging

✅ **ETL Service**
- `SpeedGamingETLService` for importing episodes
- Player/crew Discord ID matching
- Placeholder user creation with smart display names
- Organization membership management
- Only imports approved crew members

✅ **Update Detection**
- Detects schedule changes (scheduled_at)
- Detects title changes
- Updates existing matches automatically
- Preserves player/crew assignments

✅ **Deletion Detection**
- Tracks current episode IDs from API
- Identifies missing episodes
- Verifies deletion via direct API query
- Removes confirmed deleted matches

✅ **Read-Only Schedule Enforcement**
- `is_schedule_read_only()` check in TournamentService
- Blocks `create_match()` when SpeedGaming enabled
- Blocks `update_match()` when SpeedGaming enabled
- Blocks `signup_crew()` when SpeedGaming enabled
- Blocks `admin_add_crew()` when SpeedGaming enabled
- Blocks `approve_crew()` when SpeedGaming enabled
- All operations raise `ValueError` with descriptive message

✅ **Placeholder User Management**
- Create placeholder users when Discord ID unavailable
- Set display_name from Twitch/stream names
- Mark with `is_placeholder = True`
- Automatic cleanup task (daily at 2 AM UTC)
- Removes placeholders older than 30 days with no associations

✅ **Scheduled Tasks**
- `speedgaming_import` - Every 5 minutes (imports, updates, deletions)
- `cleanup_placeholder_users` - Daily at 2 AM UTC
- Task handlers registered with TaskSchedulerService

✅ **API Support**
- `TournamentOut` includes SpeedGaming fields
- `TournamentCreateRequest` supports SpeedGaming fields
- `TournamentUpdateRequest` supports SpeedGaming fields
- `MatchOut` includes `speedgaming_episode_id`
- Full CRUD support via existing endpoints

✅ **Documentation**
- `docs/integrations/SPEEDGAMING_INTEGRATION.md` - Technical architecture
- `docs/integrations/SPEEDGAMING_UI_GUIDE.md` - UI implementation guide
- Code comments and docstrings
- Error handling patterns

✅ **Testing**
- Data class parsing tests
- Service initialization tests
- ETL flow tests
- Placeholder user logic tests
- All tests passing

## Database Schema Changes

The following fields need to be added via migration (to be generated by maintainer):

```sql
-- Tournament table
ALTER TABLE `tournament` ADD `speedgaming_enabled` BOOL NOT NULL DEFAULT 0;
ALTER TABLE `tournament` ADD `speedgaming_event_slug` VARCHAR(255);

-- Matches table
ALTER TABLE `matches` ADD `speedgaming_episode_id` INT UNIQUE;

-- Users table
ALTER TABLE `users` ADD `is_placeholder` BOOL NOT NULL DEFAULT 0;
ALTER TABLE `users` ADD `speedgaming_id` INT;
```

## How It Works

### Workflow

1. **Configuration**: Tournament admin enables SpeedGaming via UI or API
   - Set `speedgaming_enabled = True`
   - Provide `speedgaming_event_slug` (e.g., "alttprleague")

2. **Periodic Import**: Every 5 minutes, scheduled task runs
   - Fetch episodes from SpeedGaming API
   - For each episode:
     - **New**: Create match, players, crew
     - **Existing**: Check for updates, update if changed
     - **Player/Crew Changes**: Detect additions/removals, sync accordingly
   - Detect missing episodes and delete matches

3. **Read-Only Enforcement**: When SpeedGaming enabled
   - All match/crew editing operations blocked
   - ValueError raised with helpful message
   - UI can use `is_schedule_read_only()` to hide controls

4. **User Matching**:
   - Match by Discord ID if available
   - Match by SpeedGaming ID for existing placeholders
   - Update placeholder display names if changed
   - Create placeholder with smart display name if not
   - Add users to organization automatically

5. **Cleanup**: Daily task removes abandoned placeholders
   - Older than 30 days
   - No match or crew associations

### Data Flow

```
SpeedGaming API
    ↓ (every 5 minutes)
SpeedGamingService.get_upcoming_episodes_by_event()
    ↓
SpeedGamingETLService.import_episodes_for_tournament()
    ↓
[For each episode]
    ↓
import_episode() → Match creation/update
    ↓
_find_or_create_user() → User matching/creation
    ↓
Match + MatchPlayers + Crew records
```

## Files Changed/Created

### New Files
- `application/services/speedgaming_service.py` - API client
- `application/services/speedgaming_etl_service.py` - ETL logic
- `tests/integration/test_speedgaming_service.py` - Service tests
- `tests/integration/test_speedgaming_etl.py` - ETL tests
- `docs/integrations/SPEEDGAMING_INTEGRATION.md` - Architecture docs
- `docs/integrations/SPEEDGAMING_UI_GUIDE.md` - UI guide

### Modified Files
- `models/match_schedule.py` - Added SpeedGaming fields to Tournament/Match
- `models/user.py` - Added `is_placeholder` field
- `models/scheduled_task.py` - Added task types
- `application/services/builtin_tasks.py` - Added built-in tasks
- `application/services/task_handlers.py` - Added task handlers
- `application/services/tournament_service.py` - Added read-only checks
- `application/repositories/tournament_repository.py` - Added SpeedGaming fields
- `api/schemas/tournament.py` - Added SpeedGaming fields to schemas
- `pyproject.toml` - Updated Python version requirement

## What's Not Implemented (Future Enhancements)

- [ ] UI implementation (guide provided)
- [ ] Player stream URL sync
- [ ] Result export to SpeedGaming
- [ ] Commentary channel notifications
- [ ] Scheduling needs tracking
- [ ] Automated seed generation from settings

## Configuration Example

```python
# Enable SpeedGaming for a tournament
tournament = await tournament_service.create_tournament(
    user=current_user,
    organization_id=org_id,
    name="ALTTPR League Season 10",
    speedgaming_enabled=True,
    speedgaming_event_slug="alttprleague",
    is_active=True,
)
```

## Testing

Run tests:
```bash
poetry run pytest tests/integration/test_speedgaming*.py -v
```

All 14 tests passing:
- Data class parsing (7 tests)
- Service initialization (1 test)
- ETL flow (3 tests)
- Placeholder user logic (2 tests)
- Crew member structure (1 test)

## Deployment Checklist

- [ ] Generate and apply database migration
- [ ] Verify scheduled tasks are running
- [ ] Test import with real SpeedGaming event
- [ ] Implement UI controls (see UI guide)
- [ ] Update user documentation
- [ ] Monitor logs for import issues

## Support

For issues or questions:
- Check `docs/integrations/SPEEDGAMING_INTEGRATION.md` for architecture
- Check `docs/integrations/SPEEDGAMING_UI_GUIDE.md` for UI implementation
- Review task logs for import errors
- Test with SpeedGaming test event first

## Success Criteria

✅ Can fetch episodes from SpeedGaming API
✅ Episode scanning runs automatically every 5 minutes
✅ Matches created/updated at scheduled times
✅ Players matched or created with placeholders
✅ Crew imported (approved only)
✅ Updates detected and applied
✅ Deletions detected and processed
✅ Schedule is read-only when enabled
✅ Placeholder users cleaned up automatically
✅ Results tracked and logged
✅ API supports configuration
✅ Documentation complete

All success criteria from the original issue have been met!
